blueprint:
  name: EMHASS Deferrable Load Controller for PV Battery over modbus
  description: |
    This blueprint manages the complete lifecycle of a **single deferrable load** for EMHASS.
    It acts as the interface between your physical device (e.g., a switch) and the main `EMHASS Basic Automation`.

    You will need one automation based on this blueprint **for each** deferrable load you want to control.

    **Core Functions:**
    * **State Management:** Controls an `input_select` helper to track the load's state (`done`, `wait`, `running`, `force`).
    * **Configuration Output:** Generates the necessary JSON configuration in an `input_text` helper.
    * **Device Control:** Starts and stops your physical device (e.g., `switch`, `input_number`) based on the EMHASS optimization plan.
    * **Flexible Strategies:** Provides multiple strategies to define how a load is started (e.g., by EMHASS) and how it's marked as complete (e.g., by a power sensor).
    * **Modus integration:** Update the modbus register from the inverter to load the home battery ([community.home-assistant.io](https://community.home-assistant.io/t/energy-dashboard-gone-crazy-after-activation-of-battery-kostal-plenticore-ksem-byd/561851/8))

    **Requirements:**
    * The [EMHASS: Energy Management Optimization for Home Assistant](https://github.com/davidusb-geek/emhass) add-on.
    * The `EMHASS Basic Automation` blueprint (emhass_basic.yaml) must be installed and configured.
    * For each load, you must create two Home Assistant Helpers:
        1.  An `input_text` helper (max 255 chars) for the JSON data.
        2.  An `input_select` helper with the options: `done`, `wait`, `running`, `force`.
    * Add this line `modbus: !include modbus.yaml` to your home-assistant "configuration.yaml" and to the `modbus.yaml` this lines (exmple)
    ```
      - name: "PLENTICORE10"
        type: tcp
        host: YOUR-IP
        port: 1502
        sensors:
          - name: kostal_load_from_gid_modbus
            slave: 71
            address: 1034
            input_type: holding
            data_type: uint32
            scan_interval: 20
    ```
    **IMPORTANT**: This reads the same register that we describe in your controller!

    **Setup:**
    After configuring this automation, you **must** add the `input_text` helper you created to the "List of EMHASS Deferrable Loads" input in your main `EMHASS Basic Automation`.
  domain: automation
  author: DanielBY27
  homeassistant:
    min_version: 2025.10.0

# ------------------------
# --- EMHASS Trigger Input
# ------------------------

  input:

    # --- PV Battery / modbus Inputs
    pv_battery_trigger_config:
      name: PV Battery / modbus configuration
      description: >
        Configures the PV Battery / modbus logic for loads and the neede power.
      collapsed: true
      input:
        pv_battery_modbus_trigger_sensor:
          name: Modbus read / write sensor
          description: >
            The installed sensor reads the load that we are currently charging from the grid into the battery.
            When this value changes, we write to the register again to load.
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: sensor
        pv_battery_modbus_hub:
          name: Modbus hub name
          description: >
            Modbus hub name
          default: PLENTICORE10
          selector:
            text:
              multiline: false
        pv_battery_modbus_address:
          name: Modbus address
          description: >
            Modbus address
          default: 1036
          selector:
            number:
              min: 0
              max: 65535
              step: 1
              mode: box
        pv_battery_modbus_unit:
          name: Modbus unit
          description: >
            Modbus unit
          default: 71
          selector:
            number:
              min: 1
              max: 255
              step: 1
              mode: box
        pv_battery_modbus_value:
          name: Modbus value
          description: >
            Modbus value as json array
          default: "[0, 49864]"
          selector:
            text:
              multiline: false

    # --- EMHASS Trigger
    grid_basic_trigger_config:
      name: Load Control & State Management
      description: >
        Configures the core logic: Which entities are used for the status, when the charging process is set to 'wait', and when it is 'done'.
      collapsed: true
      input:
        trigger_strategy:
          name: Control Strategy (Start- & Stop-Logic)
          description: |
            Defines how the automation controls the charging process. Choose a strategy based on how your device is controlled.
            **Wait:** When does the load enter the 'wait' status? (Sensor or Time).
            **Start:** The start is *always* done by EMHASS (when sensor.p_deferrableX > 0).
            **Done:** What marks the load as 'done'? (Sensor or EMHASS).
            **Action when Done:** IMPORTANT! Choose whether your device remains ON (1, 2) or is turned OFF (3-6) at the end.
          default: "1"
          selector:
            select:
              options:
                - label: "(1) Wait: Sensor | Done: Sensor | Device: Stays ON"
                  value: "1"
                - label: "(2) Wait: Time | Done: Sensor | Device: Stays ON"
                  value: "2"
                - label: "(3) Wait: Sensor | Done: EMHASS | Device: Turns OFF"
                  value: "3"
                - label: "(4) Wait: Time | Done: EMHASS | Device: Turns OFF"
                  value: "4"
                - label: "(5) Wait: Sensor | Done: Sensor or EMHASS | Device: Turns OFF"
                  value: "5"
                - label: "(6) Wait: Time | Done: Sensor or EMHASS | Device: Turns OFF"
                  value: "6"
        wait_times_hours:
          name: "Time Trigger: Hours"
          description: >
            CRON pattern for the hour (e.g., 10 or /4). Only used for 'Wait: Time' strategies (2, 4, 6).
          default: "0"
          selector:
            text:
              multiline: false
        wait_times_minutes:
          name: "Time Trigger: Minutes"
          description: >
            CRON pattern for the minute (e.g., 30 or /5). Only used for 'Wait: Time' strategies (2, 4, 6).
          default: "5"
          selector:
            text:
              multiline: false
        input_status:
          name: Status Helper (Input Select)
          description: >
            The `input_select` helper that stores the status of this load. MUST have the options: `done`, `wait`, `running` and `force`.
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: input_select
        input_emhass:
          name: EMHASS JSON Helper (Input Text)
          description: >
            The `input_text` helper (max. 255 characters) where this automation writes its JSON data. This entity must be added in the main `EMHASS Basic Automation` blueprint!
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: input_text
        input_trigger:
          name: EMHASS Deferrable Sensor
          description: >
            The associated `sensor.p_deferrableX` sensor created by EMHASS. The state of this sensor (> 0) is used to start the load.
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: sensor
        wait_sensor:
          name: Sensor for 'Wait' Status
          description: >
            The sensor (e.g., power sensor indicating idle) used to set the load to 'wait' status. Only for 'Wait: Sensor' strategies.
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: sensor
        wait_value:
          name: Threshold for 'Wait' Status
          description: >
            The value that the 'Wait Sensor' **must exceed** to set the status to 'wait'.
          default:
          selector:
            number:
              min: 1
              max: 1000
              step: 1
              mode: box
        skipp_wait_to_force:
          name: Skip 'Wait' and Force 'Running'
          description: >
            When enabled, the automation skips the 'wait' status and goes directly to 'force' ('running') as soon as the 'Wait Sensor' threshold is reached. This starts the load immediately and bypasses EMHASS optimization.
          default: false
          selector:
            boolean:
        stop_sensor:
          name: Sensor for 'Done' Status
          description: >
            The sensor (e.g., power sensor indicating 'finished') used to set the load to 'done' status. Only for 'Done: Sensor' strategies.
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: sensor
        stop_value:
          name: Threshold for 'Done' Status
          description: >
            The value that the 'Done Sensor' **must fall below** to set the status to 'done'.
          default:
          selector:
            number:
              min: 1
              max: 1000
              step: 1
              mode: box
        stop_value_overwrite:
          name: "'Done' Value Overwrite (for Number)"
          description: >
            (Optional) Only used if 'Load Control Entity' is a `number` or `input_number`. Sets a specific value when the load is 'done'. Set to -1 to use the current value of the 'Done Sensor' instead.
          default: -1
          selector:
            number:
              min: -1
              max: 1000
              step: 1
              mode: box
        update_sensor:
          name: Load Control Entity (Device Control)
          description: >
            (Optional) The entity (`switch`, `input_boolean`, `number` etc.) that controls your physical device. This automation will turn this entity ON or OFF.
            **Leave this blank** if you use a separate, dedicated automation to control your device (e.g., for a complex Wallbox that reacts to the EMHASS sensor directly).
          default: null
          selector:
            entity:
              multiple: false
              filter:
                domain:
                  - number
                  - input_number
                  - switch
                  - input_boolean
        allow_allways_to_done:
          name: Always Allow 'Done' Status
          description: >
            (Advanced) When enabled, the 'Done Sensor' can set the status to 'done' even if the status is not 'running' (e.g., if it is in the 'wait' state).
            This is useful for `si: false` (multi-block) loads that may be manually stopped, or to reset the automation if it gets stuck.
          default: false
          selector:
            boolean:

    # --- EMHASS Deferrable Load
    grid_basic_deferrable_load_config:
      name: EMHASS Load Parameters
      description: >
        Defines the technical parameters of this load. This data is used for EMHASS optimization.
      collapsed: true
      input:
        emhass_config_optimization_time_step:
          name: Optimization Time Step (Minutes)
          description: >
            The `optimization_time_step` from your EMHASS configuration. **MUST** match the value in your `EMHASS Basic Automation` (e.g., 30).
            **Important**: If this is changed, the `start` and `end timestamps` in the load controllers must be adjusted (30 minutes = 2 units, 15 minutes = 4 units per hour).
            In the automation controller, `load_cost_forecast` and `p_pv_forecast` must be adjusted (30 minutes = 48 entries, 15 minutes = 96 entries in the array).
          default: "30"
          selector:
            select:
              options:
                - "60"
                - "30"
                - "15"
        nominal_powers:
          name: Nominal Power (po)
          description: >
            The power consumption of the load in Watts (W) when it is running. (Parameter: `po`)
          default:
          selector:
            number:
              min: 10
              max: 22000
              step: 10
              mode: box
        operating_hours:
          name: Operating Hours (ho)
          description: >
            The total time in hours (e.g., `1.5` for 90 minutes) the load requires for one cycle. Can be a template. (Parameter: `ho`)
          default:
          selector:
            text:
              multiline: true
        start_timesteps:
          name: Earliest Start Timestep (st)
          description: >
            The earliest time the load is allowed to start. This is an index, not a time. (e.g., `0` = 0 Hours, `6` = 3 Hours, for 30min steps). (Parameter: `st`)
          default:
          selector:
            number:
              min: 0
              max: 48
              step: 0.5
              mode: box
        end_timesteps:
          name: Latest End Timestep (et)
          description: >
            The latest time (index) by which the load **must** be finished. (e.g., `12` = 6 Hours, for 30min steps). Can be a template. (Parameter: `et`)
          default:
          selector:
            text:
              multiline: true
        deferrable_load_as_semi_cont:
          name: Semi-Continuous Load / Power Modulation (se)
          description: |
            This parameter defines **HOW** the load consumes power. (Parameter: `se`)
            **false (Default):** The load is binary (ON/OFF). When ON, it consumes the full 'Nominal Power' (po).
            **true:** The load is modulatable (variable). When OFF, EMHASS can schedule it to consume any power *between* 'Minimum Power' (mp) and 'Nominal Power' (po). (e.g., a smart EV charger that can adjust its amps).
          default: false
          selector:
            boolean:
        deferrable_load_single_constant:
          name: Single Uninterrupted Block / Time Scheduling (si)
          description: |
            This parameter defines **WHEN** the load runs. (Parameter: `si`)
            **true (Default):** The load is an "uninterruptible block". EMHASS must schedule the *entire* 'Operating Hours' (ho) in one single, continuous time block. (e.g., a dishwasher).
            **false:** The load is "interruptible". EMHASS can split the 'Operating Hours' (ho) into multiple, separate time blocks (e.g., an EV charger that can pause when power is expensive).
          default: true
          selector:
            boolean:
        deferrable_load_single_constant_work:
          name: "Behavior when 'si: false'"
          description: >
            (Advanced) Behavior for interruptible loads (si: false) after a partial run.
            "True" (default) = Return to 'wait' if more runtime is scheduled.
            "False" = Always go to 'done' (useful for surplus-only loads that shouldn't create new demand).
          default: "True"
          selector:
            text:
              multiline: true
        minimum_power_deferrable_load:
          name: Minimum Power (mp)
          description: >
            The minimum power in Watts (W) that must be scheduled when the load is running. (Parameter: `mp`)
          default:
          selector:
            number:
              min: 10
              max: 22000
              step: 10
              mode: box
        deferrable_startup_penalty:
          name: Prioritization Penalty (pe)
          description: >
            A cost/penalty value for starting this load, used for prioritization. A **higher** value gives this load a **lower** priority (it will be scheduled later). (Parameter: `pe`)
          default: 0
          selector:
            number:
              min: 0
              max: 30
              step: 1
              mode: box

    # --- EMHASS Notify
    grid_basic_notify_config:
      name: Notifications
      description: >
        (Optional) Sends notifications when the load's status changes.
      collapsed: true
      input:
        notify_wait:
          name: "'Wait' Notification"
          description: >
            (Optional) Message sent when the load changes to 'wait' status.
          default: ""
          selector:
            text:
              type: text
        notify_running:
          name: "'Running' Notification"
          description: >
            (Optional) Message sent when the load starts ('running').
          default: ""
          selector:
            text:
              type: text
        notify_done:
          name: "'Done' Notification"
          description: >
            (Optional) Message sent when the load is finished ('done').
          default: ""
          selector:
            text:
              type: text
        notify_group:
          name: Notification Service
          description: >
            The notification service to use. Example: "mobile_app_handy" ; importantly, it must be in the notify domain.
          default:
          selector:
            text:
              type: text

# ----------------------------
# --- EMHASS Trigger Variables
# ----------------------------

variables:

  automation_logger_name: homeassistant.components.automation.{{ this.entity_id.split('.')[1] }}
  emhass_step: !input emhass_config_optimization_time_step
  input_allow_allways_to_done: !input allow_allways_to_done
  input_trigger_strategy: !input trigger_strategy
  input_trigger_sensor: !input input_trigger
  input_trigger_sensor_str: "{{ input_trigger_sensor | string }}"
  input_update_sensor: !input update_sensor
  input_update_sensor_str: "{{ input_update_sensor | string | lower }}"
  input_status_sensor: !input input_status
  input_status_sensor_str: "{{ input_status_sensor | string }}"
  input_notify_group: !input notify_group
  input_notify_wait: !input notify_wait
  input_notify_running: !input notify_running
  input_notify_done: !input notify_done
  input_wait_sensor: !input wait_sensor
  input_wait_value: !input wait_value
  input_skipp_wait_to_force: !input skipp_wait_to_force
  input_wait_sensor_str: "{{ input_wait_sensor | string }}"
  input_wait_times_hours: !input wait_times_hours
  input_wait_times_minutes: !input wait_times_minutes
  input_stop_sensor: !input stop_sensor
  input_stop_value: !input stop_value
  input_stop_value_overwrite: !input stop_value_overwrite
  input_stop_sensor_str: "{{ input_stop_sensor | string }}"
  input_emhass_sensor: !input input_emhass
  input_po: !input nominal_powers
  input_st: !input start_timesteps
  input_se: !input deferrable_load_as_semi_cont
  input_si: !input deferrable_load_single_constant
  input_si_work_raw: !input deferrable_load_single_constant_work
  input_si_work: >
    {% set raw_value = input_si_work_raw | string | trim %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% else %}
      {{ raw_value | bool }}
    {% endif %}
  input_mp: !input minimum_power_deferrable_load
  input_pe: !input deferrable_startup_penalty
  input_ho_raw: !input operating_hours
  input_ho: >
    {% set raw_value = input_ho_raw | string | trim %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% else %}
      {{ raw_value | float(1 / (60 / (emhass_step | float(30)))) }}
    {% endif %}
  end_timesteps_raw: !input end_timesteps
  end_timesteps: >
    {% set raw_value = end_timesteps_raw | string | trim %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% else %}
      {{ raw_value | int(input_st + 1 | int(12)) }}
    {% endif %}
  payload_emhass_settings: >-
    {% set payload = {
      "po": input_po | int(0),
      "ho": input_ho | float(0),
      "st": input_st | int(0) | round(0),
      "et": end_timesteps | int(0) | round(0),
      "se": input_se | bool,
      "si": input_si | bool,
      "mp": input_mp | int(0),
      "pe": input_pe | int(0),
      "us": "unknown"
    } %}
    {{ payload | to_json }}

  pv_modbus_json: !input pv_battery_modbus_value

# ---------------------------
# --- EMHASS Trigger Triggers
# ---------------------------

triggers:

  # --- Wait Trigger
  - trigger: numeric_state
    entity_id:
      - !input wait_sensor
    above: !input wait_value
    id: wait
  - trigger: time_pattern
    hours: !input wait_times_hours
    minutes: !input wait_times_minutes
    seconds: 3
    id: wait_cron
  # --- Force Trigger
  - trigger: state
    entity_id:
      - !input input_status
    not_from:
    - unknown
    - unavailable
    to: force
    id: force
  # --- Running Trigger
  - trigger: state
    entity_id:
      - !input input_status
    not_from:
    - unknown
    - unavailable
    to: running
    id: running
  - trigger: numeric_state
    entity_id:
      - !input input_trigger
    above: 0
    id: running_emhass
  # --- Done Trigger
  - trigger: numeric_state
    entity_id:
      - !input stop_sensor
    below: !input stop_value
    id: done
  - trigger: numeric_state
    entity_id:
      - !input input_trigger
    below: 1
    id: done_emhass
  # --- PV Battery / modbus Trigger
  - trigger: numeric_state
    entity_id:
      - !input pv_battery_modbus_trigger_sensor
    below: 1
    id: pv_modbus_load_changed

# -----------------------------
# --- EMHASS Trigger Conditions
# -----------------------------

conditions:

  - condition: or
    conditions:

      # --- EMHASS Trigger Condition wait
      - condition: and
        conditions:
          - condition: trigger
            id:
              - wait
              - wait_cron
          - condition: state
            entity_id: !input input_status
            state: done
          - condition: numeric_state
            entity_id: !input wait_sensor
            above: !input wait_value
          - condition: template
            value_template: "{{ input_ho >= (1 / (60 / (emhass_step | float(30)))) }}"
          - condition: template
            value_template: "{{ input_po >= 100 }}"
          - condition: or
            conditions:
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['1', '3', '5'] }}"
                  - condition: trigger
                    id: wait
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['2', '4', '6'] }}"
                  - condition: trigger
                    id: wait_cron

      # --- EMHASS Trigger Condition running
      - condition: and
        conditions:
          - condition: trigger
            id:
              - running
              - running_emhass
              - force
          - condition: template
            value_template: "{{ states(input_status_sensor_str) | string in ['done', 'wait', 'force'] }}"

      # --- EMHASS Trigger Condition done
      - condition: and
        conditions:
          - condition: trigger
            id:
              - done
              - done_emhass
          - condition: or
            conditions:
              - condition: state
                entity_id: !input input_status
                state: running
              - condition: template
                value_template: "{{ input_allow_allways_to_done | bool }}"
          - condition: or
            conditions:
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['1', '2', '5', '6'] }}"
                  - condition: trigger
                    id: done
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['3', '4', '5', '6'] }}"
                  - condition: trigger
                    id: done_emhass

      # --- PV Battery / modbus Condition
      - condition: and
        conditions:
          - condition: trigger
            id:
              - pv_modbus_load_changed
          - condition: template
            value_template: "{{ states(input_status_sensor_str) | string in ['running'] }}"

# --------------------------
# --- EMHASS Trigger Actions
# --------------------------

actions:

  # --- Run EMHASS wait ---
  - alias: Run trigger wait
    if:
      - condition: trigger
        id:
          - wait
          - wait_cron
    then:
      - alias: If Switch or input_boolen then power off
        choose:
          - conditions:
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('switch.') }}"
            sequence:
              - action: switch.turn_off
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('input_boolean.') }}"
            sequence:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input update_sensor
      - action: input_select.select_option
        data:
          option: wait
        target:
            entity_id: !input input_status
      - if:
          - condition: template
            value_template: "{{ input_skipp_wait_to_force == true }}"
        then:
          - action: input_select.select_option
            data:
              option: force
            target:
                entity_id: !input input_status
      # --- Run Notify
      - if:
          - condition: template
            value_template: "{{ input_notify_wait is not none and input_notify_wait | trim != '' }}"
        then:
          - alias: Send Message
            action: "notify.{{ input_notify_group }}"
            data:
              message: "{{ input_notify_wait }}"

  # --- Run EMHASS running ---
  - alias: Run trigger running
    if:
      - condition: trigger
        id:
          - running
          - running_emhass
          - force
    then:
      - alias: If Switch or input_boolen then power on by Number or input_number set value from wait_sensor
        choose:
          - conditions:
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('switch.') }}"
            sequence:
              - action: switch.turn_on
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('input_boolean.') }}"
            sequence:
              - action: input_boolean.turn_on
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('number.') }}"
            sequence:
              - action: number.set_value
                data:
                  value: "{{ states(input_wait_sensor_str) | float | round(0) }}"
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('input_number.') }}"
            sequence:
              - action: input_number.set_value
                data:
                  value: "{{ states(input_wait_sensor_str) | float | round(0) }}"
                target:
                  entity_id: !input update_sensor
      - action: input_select.select_option
        data:
          option: running
        target:
            entity_id: !input input_status

      # --- Run Notify
      - if:
          - condition: template
            value_template: "{{ input_notify_running is not none and input_notify_running | trim != '' }}"
        then:
          - alias: Send Message
            action: "notify.{{ input_notify_group }}"
            data:
              message: "{{ input_notify_running }}"

  # --- Run EMHASS done
  - alias: Run trigger done
    if:
      - condition: trigger
        id:
          - done
          - done_emhass
    then:
      - alias: Power off by trigger strategy
        choose:
          # --- Ensure that the strategy is followed and the devices are switched off
          - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ input_trigger_strategy | string in ['3', '4'] }}"
                    - condition: template
                      value_template: "{{ trigger.id == 'done_emhass' }}"
                    - condition: template
                      value_template: "{{ input_update_sensor_str.startswith('switch.') }}"
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ input_trigger_strategy | string in ['5', '6'] }}"
                    - condition: template
                      value_template: "{{ input_update_sensor_str.startswith('switch.') }}"
            sequence:
              - action: switch.turn_off
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ input_trigger_strategy | string in ['3', '4'] }}"
                    - condition: template
                      value_template: "{{ trigger.id == 'done_emhass' }}"
                    - condition: template
                      value_template: "{{ input_update_sensor_str.startswith('input_boolean.') }}"
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ input_trigger_strategy | string in ['5', '6'] }}"
                    - condition: template
                      value_template: "{{ input_update_sensor_str.startswith('input_boolean.') }}"
            sequence:
              - action: input_boolean.turn_off
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['3', '4'] }}"
                  - condition: template
                    value_template: "{{ trigger.id == 'done_emhass' }}"
                  - condition: template
                    value_template: "{{ input_update_sensor_str.startswith('number.') }}"
                - condition: and
                  conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['5', '6'] }}"
                  - condition: template
                    value_template: "{{ input_update_sensor_str.startswith('number.') }}"
            sequence:
              - action: number.set_value
                data:
                  value: >
                    {% if input_stop_value_overwrite == -1 %}
                      {{ states(input_stop_sensor_str) | float(0) | round(0) }}
                    {% else %}
                      {{ input_stop_value_overwrite | float(0) | round(0) }}
                    {% endif %}
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['3', '4'] }}"
                  - condition: template
                    value_template: "{{ trigger.id == 'done_emhass' }}"
                  - condition: template
                    value_template: "{{ input_update_sensor_str.startswith('input_number.') }}"
                - condition: and
                  conditions:
                  - condition: template
                    value_template: "{{ input_trigger_strategy | string in ['5', '6'] }}"
                  - condition: template
                    value_template: "{{ input_update_sensor_str.startswith('input_number.') }}"
            sequence:
              - action: input_number.set_value
                data:
                  value: >
                    {% if input_stop_value_overwrite == -1 %}
                      {{ states(input_stop_sensor_str) | float(0) | round(0) }}
                    {% else %}
                      {{ input_stop_value_overwrite | float(0) | round(0) }}
                    {% endif %}
                target:
                  entity_id: !input update_sensor
            # --- Ensure that the strategy is followed and the devices are switched on
          - conditions:
            - condition: template
              value_template: "{{ input_trigger_strategy | string in ['1', '2'] }}"
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('switch.') }}"
            sequence:
              - action: switch.turn_on
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_trigger_strategy | string in ['1', '2'] }}"
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('input_boolean.') }}"
            sequence:
              - action: input_boolean.turn_on
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_trigger_strategy | string in ['1', '2'] }}"
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('number.') }}"
            sequence:
              - action: number.set_value
                data:
                  value: "{{ states(input_stop_sensor_str) | float | round(0) }}"
                target:
                  entity_id: !input update_sensor
          - conditions:
            - condition: template
              value_template: "{{ input_trigger_strategy | string in ['1', '2'] }}"
            - condition: template
              value_template: "{{ input_update_sensor_str.startswith('input_number.') }}"
            sequence:
              - action: input_number.set_value
                data:
                  value: "{{ states(input_stop_sensor_str) | float | round(0) }}"
                target:
                  entity_id: !input update_sensor

      # --- If deferrable_load_single_constant is false and there is another load in the deferrable sensor,
      # --- then we set the status to wait and not to done.
      - if:
          - condition: template
            value_template: "{{ input_si | bool is false }}"
          - condition: template
            value_template: >
              {% set schedule = state_attr(input_trigger_sensor_str, 'deferrables_schedule') | default([]) %}
              {% set attribute_name = input_trigger_sensor_str.split('.')[1] %}
              {% set schedule_sum = schedule | map(attribute=attribute_name) | map('float', 0) | sum | round(2)  %}
              {{ schedule_sum > 0 }}
          - condition: template
            value_template: >
              {{ input_si_work | bool }}
        then:
          - action: input_select.select_option
            data:
              option: wait
            target:
                entity_id: !input input_status
        else:
          - action: input_select.select_option
            data:
              option: done
            target:
                entity_id: !input input_status

      # --- Run Notify
      - if:
          - condition: template
            value_template: "{{ input_notify_done is not none and input_notify_done | trim != '' }}"
        then:
          - alias: Send Message
            action: "notify.{{ input_notify_group }}"
            data:
              message: "{{ input_notify_done }}"

  # --- Run Save settings
  - alias: Update EMHASS JSON test field
    if:
      - condition: trigger
        id:
          - wait
          - wait_cron
          - force
          - running
          - running_emhass
          - done
          - done_emhass
    then:
      - alias: Update EMHASS settings
        action: input_text.set_value
        data:
          value: >
            {% set status = states(input_status_sensor_str) %}
            {% set original_dict = payload_emhass_settings | from_json %}
            {% set updated_dict = original_dict | combine({"us": status}) %}
            {{ updated_dict | to_json }}
        target:
          entity_id: !input input_emhass

  # --- PV Battery / modbus action
  - alias: Run EMHASS modbus pv battery load
    if:
      - condition: trigger
        id:
          - running
          - running_emhass
          - force
          - pv_modbus_load_changed
    then:
      - action: modbus.write_register
        data:
          hub: !input pv_battery_modbus_hub
          address: !input pv_battery_modbus_address
          unit: !input pv_battery_modbus_unit
          value: >
            {{ pv_modbus_json | from_json }}

# -------------------
# --- Automation Mode
# -------------------

mode: single
