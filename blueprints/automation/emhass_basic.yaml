blueprint:
  name: EMHASS Basic Automation Controller (v202512)
  description: |
    This blueprint acts as the central controller for the EMHASS (Energy Management Optimization for Home Assistant) integration.
    It is the **only** automation that should communicate directly with the EMHASS add-on.

    **Core Functions:**
    * **Manages Timers:** Controls the scheduled execution of EMHASS actions (Publish, Optimization, ML Forecast, Config Save).
    * **Central Configuration:** Provides a UI to configure all core EMHASS parameters.
    * **Dynamic Deferrable Loads:** Collects and aggregates data from one or more `EMHASS Deferrable Load Controller` blueprints.
    * **REST API Calls:** Executes the `rest_command` calls to the EMHASS API for all actions.

    **Requirements:**
    * The [EMHASS: Energy Management Optimization for Home Assistant](https://github.com/davidusb-geek/emhass) add-on.
    * A `rest_command` service defined in your `configuration.yaml` (e.g., `rest_command.emhass_rest_command`).
    * (Optional) One or more automations based on the `EMHASS Deferrable Load Controller` (emhass_basic_trigger.yaml) blueprint.
  domain: automation
  source_url: https://github.com/DanielBY27/Home-Assistant/blob/main/blueprints/automation/emhass_basic.yaml
  author: DanielBY27
  homeassistant:
    min_version: 2025.10.0

# ----------------
# --- EMHASS Input
# ----------------

  input:

    # --- EMHASS Input Timer
    grid_emhass_timer_config:
      name: Timer & Logging Settings
      description: >
        Configure the CRON timers that trigger the main EMHASS actions.
      collapsed: true
      input:
        enable_publish_timer:
          name: Enable Publish & Optimization Timer (5 min interval)
          description: >
            Controls whether the publish trigger (and optimization, if needed) runs every 5 minutes.
          default: false
          selector:
            boolean:
        publish_minutes_timer:
          name: Publish Timer - CRON Minutes Pattern
          description: >
            Minute pattern for the EMHASS publish action (e.g., /5 for every 5 minutes).
          default: "/5"
          selector:
            select:
              options:
                - "/5"
                - "/10"
                - "/15"
                - "/30"
                - "/45"
                - "/60"
        enable_forecast_timer:
          name: Enable ML Forecast Timer (daily)
          description: >
            Controls whether the daily machine learning forecast training is triggered.
          default: false
          selector:
            boolean:
        forecast_timer_hours:
          name: ML Forecast Timer - CRON Hours Pattern
          description: >
            Hour pattern for the EMHASS forecast action (e.g., 5 for 5:00 AM).
          default: "5"
          selector:
            text:
              multiline: false
        forecast_timer_minutes:
          name: ML Forecast Timer - CRON Minutes Pattern
          description: >
            Minute pattern for the EMHASS forecast action (e.g., 27 for 5:27 AM).
          default: "27"
          selector:
            text:
              multiline: false
        enable_save_timer:
          name: Enable Save-Config Timer (daily)
          description: >
            Controls whether the daily save-config trigger is enabled. This persists the settings below to your EMHASS config file.
          default: false
          selector:
            boolean:
        save_timer_hours:
          name: Save-Config Timer - CRON Hours Pattern
          description: >
            Hour pattern for the EMHASS save action (e.g., 5).
          default: "5"
          selector:
            text:
              multiline: false
        save_timer_minutes:
          name: Save-Config Timer - CRON Minutes Pattern
          description: >
            Minute pattern for the EMHASS save action (e.g., 37).
          default: "37"
          selector:
            text:
              multiline: false
        automation_trace_count:
          name: Number of traces
          description: >
            Number of traces to be saved by this automation
          default: 10
          selector:
            number:
              min: 5
              max: 90
              step: 1
              mode: box
        automation_started_manually:
          name: Automation started manually by user
          description: >
            If the automation is started manually, which section should be executed (log only = default)?
          default: log
          selector:
            select:
              options:
                - label: log
                  value: log
                - label: save
                  value: save
                - label: forecast
                  value: forecast
                - label: optim
                  value: optim
                - label: publish
                  value: publish
                - label: all
                  value: all
        automation_logger_level:
          name: Automation logger level
          description: >
            The logging level for this automation.
          default: INFO
          selector:
            select:
              options:
                - label: DEBUG
                  value: DEBUG
                - label: WARNING
                  value: WARNING
                - label: INFO
                  value: INFO

    # --- EMHASS Deferrable Loads Configuration
    grid_emhass_deferrable_loads_config:
      name: EMHASS Deferrable Loads Configuration
      description: >
        Links the `input_text` helpers managed by your 'EMHASS Deferrable Load Controller' automations.
      collapsed: true
      input:
        list_emhass_deferrable_loads:
          name: List of Deferrable Load Helpers (Input Text)
          description: >
            Add all `input_text` entities that are controlled by your 'EMHASS Deferrable Load Controller' blueprints.
            This automation reads the JSON data from them to build the optimization payload.
          default:
          selector:
            entity:
              multiple: true
              filter:
                domain:
                  - input_text

    # --- EMHASS Overwrite default Configuration
    grid_emhass_overwrite_config:
      name: EMHASS Runtime Overwrites
      description: >
        These settings are injected into the EMHASS API calls, primarily for optimization.
        They allow dynamic updates (e.g., SOC, forecasts) without saving to the main config file.
      collapsed: true
      input:
        emhass_config_get_data_from_home_assistant:
          name: get_data_from_home_assistant
          description: >
            (Runtime) Force EMHASS to fetch fresh data from Home Assistant before acting.
          default: true
          selector:
            boolean:
        emhass_config_force_update_data:
          name: force_update_data
          description: >
            (Runtime) Force EMHASS to update its internal data tables.
          default: true
          selector:
            boolean:
        emhass_config_set_forecast_to_hass:
          name: set_forecast_to_hass
          description: >
            (Runtime) Controls if EMHASS writes its forecast results back to Home Assistant sensors.
          default: true
          selector:
            boolean:
        emhass_config_load_cost_forecast:
          name: load_cost_forecast (Array or Template)
          description: >
            (Runtime) Overwrites the load cost forecast. Expects a template or a JSON array (e.g., [0.3] * 48 for 48 steps).
          default:
          selector:
            text:
              multiline: true
        emhass_config_p_pv_forecast:
          name: p_pv_forecast (Array or Template)
          description: >
            (Runtime) Overwrites the PV production forecast. Expects a template or a JSON array (e.g., [0] * 48 for 48 steps).
          default:
          selector:
            text:
              multiline: true
        emhass_config_solar_forecast_kwp:
          name: solar_forecast_kwp (Peak Power)
          description: >
            The peak power of your solar installation in kWp, used for Solcast/similar forecast methods.
          default: 10
          selector:
            number:
              min: 1
              max: 100
              step: 1
              mode: box
        emhass_config_soc_init:
          name: soc_init (Initial SOC Template)
          description: >
            (Runtime) Initial battery state of charge. Provide a template or a value between 0.0 and 1.0 (e.g., 0.43 for 43%).
          default:
          selector:
            text:
              multiline: true
        emhass_config_soc_final:
          name: soc_final (Target SOC Template)
          description: >
            (Runtime) Target battery state of charge at the end of the optimization period. Template or value (0.0 - 1.0).
          default:
          selector:
            text:
              multiline: true

    # --- EMHASS Connection Configuration
    grid_emhass_connection_config:
      name: EMHASS Connection Settings (IP, Port and APIs)
      description: >
        Defines how Home Assistant connects to the EMHASS add-on API.
      collapsed: true
      input:
        emhass_rest_name:
          name: REST Service Name
          description: >
            The name of the `rest_command` service defined in your configuration.yaml.
          default: rest_command.emhass_rest_command
          selector:
            text:
              type: text
        emhass_protocol:
          name: Protocol
          description: >
            The protocol for the EMHASS connection (http or https).
          default: http
          selector:
            select:
              options:
                - http
                - https
        emhass_host:
          name: Host
          description: >
            Hostname or IP address of the EMHASS Server (e.g., 'localhost' or the add-on IP).
          default: localhost
          selector:
            text:
              type: text
        emhass_port:
          name: Port
          description: >
            The port on which EMHASS is running (default is 5000).
          default: 5000
          selector:
            number:
              min: 1
              max: 65535
              mode: box
        emhass_api_publish:
          name: EMHASS Publish API
          description: >
            The EMHASS Publish API Endpoint.
          default: action/publish-data
          selector:
            text:
              type: text
        emhass_api_optim:
          name: EMHASS Optimization API
          description: >
            The EMHASS Optimization API Endpoint (e.g., dayahead-optim).
          default: action/dayahead-optim
          selector:
            text:
              type: text
        emhass_api_save:
          name: EMHASS Save-Config API
          description: >
            The EMHASS Save-Config (set-config) API Endpoint.
          default: set-config
          selector:
            text:
              type: text
        emhass_api_ml:
          name: EMHASS Forecast API
          description: >
            The EMHASS ML Forecast API Endpoint.
          default: action/forecast-model-fit
          selector:
            text:
              type: text

    # --- EMHASS Global Configuration
    grid_emhass_global_config:
      name: EMHASS Global Configuration
      description: >
        High-level settings for optimization cost function and core sensors.
      collapsed: true
      input:
        emhass_config_costfun:
          name: costfun (Cost Function)
          description: >
            The optimization goal (e.g., 'self-consumption', 'cost', 'profit').
          default: self-consumption
          selector:
            select:
              options:
                - self-consumption
                - cost
                - profit
        emhass_config_sensor_power_photovoltaics:
          name: sensor_power_photovoltaics
          description: >
            Your main sensor entity for PV production power (in W).
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: sensor
        emhass_config_sensor_power_load_no_var_loads:
          name: sensor_power_load_no_var_loads
          description: >
            Your main sensor entity for house consumption (in W), *excluding* deferrable loads.
          default:
          selector:
            entity:
              multiple: false
              filter:
                domain: sensor
        emhass_config_continual_publish:
          name: continual_publish
          description: >
            If true, EMHASS will keep publishing data even if optimization fails.
          default: false
          selector:
            boolean:
        emhass_config_logging_level:
          name: logging_level
          description: >
            The logging level for the EMHASS add-on.
          default: INFO
          selector:
            select:
              options:
                - label: DEBUG
                  value: DEBUG
                - label: INFO
                  value: INFO
                - label: WARNING
                  value: WARNING

    # --- EMHASS System Configuration
    grid_emhass_system_config:
      name: EMHASS System Configuration
      description: >
        Core technical parameters for the EMHASS optimization model.
      collapsed: true
      input:
        emhass_config_optimization_time_step:
          name: optimization_time_step
          description: >
            The time step in minutes for optimization (e.g., 30). This MUST match the setting in your 'Deferrable Load' blueprints.
            **Important**: If this is changed, the `start` and `end timestamps` in the load controllers must be adjusted (30 minutes = 2 units, 15 minutes = 4 units per hour).
            In the automation controller, `load_cost_forecast` and `p_pv_forecast` must be adjusted (30 minutes = 48 entries, 15 minutes = 96 entries in the array).
          default: "30"
          selector:
            select:
              options:
                - "60"
                - "30"
                - "15"
        emhass_config_historic_days_to_retrieve:
          name: historic_days_to_retrieve
          description: |
            Number of past days of data to retrieve from Home Assistant. However, it is advised to provide more data for better accuracy by modifying your Home Assistant recorder settings.
            Home-Assistant recorder setting example for your configuration.yaml:
            ```
            recorder:
              purge_keep_days: 60
            ```
            If you use this setting, you should closely monitor your Home Assistant database. To further control its size, you can use [automation](https://github.com/DanielBY27/Home-Assistant/blob/main/examples/automation/ha_database_purge.yaml).
          default: 9
          selector:
            number:
              min: 9
              max: 60
              step: 1
              mode: box
        emhass_config_load_negative:
          name: load_negative
          description: >
            Allow negative load values (e.g., if your load sensor includes PV).
          default: false
          selector:
            boolean:
        emhass_config_set_zero_min:
          name: set_zero_min
          description: >
            If true, clamps negative values in forecasts to zero.
          default: true
          selector:
            boolean:
        emhass_config_method_ts_round:
          name: method_ts_round
          description: >
            Method for timestamp rounding. 'nearest' is recommended.
          default: nearest
          selector:
            select:
              options:
                - nearest
        emhass_config_delta_forecast_daily:
          name: delta_forecast_daily
          description: >
            Number of days to forecast (1 = today, 2 = today and tomorrow).
          default: 1
          selector:
            number:
              min: 1
              max: 10
              step: 1
              mode: box
        emhass_config_load_forecast_method:
          name: load_forecast_method
          description: >
            Method to use for load forecasting (e.g., 'mlforecaster', 'naive', 'typical').
          default: naive
          selector:
            select:
              options:
                - mlforecaster
                - typical
                - naive
        emhass_config_mlforecaster_payload_overwrite:
          name: mlforecaster_payload_overwrite (JSON)
          description: |
            JSON definition to overwrite the mlforecaster api (forecast-model-fit) payload. Default Payload:
            ```
            {% set step = (emhass_config_optimization_time_step | int(30)) %}
            {% set num_lags = (1440 / step) | int %}
            {% set is_monday = (now().isoweekday() == 1) %}
            {
              "historic_days_to_retrieve": historic_days_to_retrieve,
              "var_model": sensor_power_load_no_var_loads,
              "sklearn_model": "KNeighborsRegressor",
              "num_lags": num_lags,
              "split_date_delta": "48h",
              "perform_backtest": is_monday | bool
            }
            ```
            Hints:
            - To check the ML R2 value, it is best to switch to the "share" folder and run the command:
              `awk '/Performing a machine learning forecast model fit/,/Obtaining params/' actionLogs.txt`
            - To find out the best parameters you can use this:
              `curl -i -H "Content-Type:application/json" -X POST -d '{"var_model": "sensor.emhass_config_home_power_no_var_loads", "historic_days_to_retrieve": 9}' http://localhost:5000/action/forecast-model-tune`
              More details [here](https://emhass.readthedocs.io/en/latest/mlforecaster.html#the-tuning-method-with-bayesian-hyperparameter-optimization)
          default: ""
          selector:
            text:
              type: text
              multiline: true
        emhass_config_set_total_pv_sell:
          name: set_total_pv_sell
          description: >
            If true, sets PV power sold to grid = total PV power - inverter self-consumption.
          default: false
          selector:
            boolean:
        emhass_config_lp_solver:
          name: lp_solver
          description: >
            The linear programming solver to use. 'default' uses the built-in solver.
          default: default
          selector:
            select:
              options:
                - default
        emhass_config_lp_solver_path:
          name: lp_solver_path
          description: >
            Path to an external solver (if not using 'default').
          default: empty
          selector:
            select:
              options:
                - empty
        emhass_config_num_threads:
          name: num_threads
          description: >
            Number of threads for the solver (0 = system default).
          default: 0
          selector:
            number:
              min: 0
              max: 100
              step: 1
              mode: box
        emhass_config_lp_solver_timeout:
          name: lp_solver_timeout
          description: >
            Maximum time (in seconds) allowed for the optimization solver.
          default: 45
          selector:
            number:
              min: 30
              max: 90
              step: 1
              mode: box
        emhass_config_weather_forecast_method:
          name: weather_forecast_method
          description: >
            Source for weather forecast data (e.g., 'open-meteo').
          default: open-meteo
          selector:
            select:
              options:
                - open-meteo
        emhass_config_open_meteo_cache_max_age:
          name: open_meteo_cache_max_age
          description: >
            Cache time (in minutes) for Open-Meteo weather data.
          default: 30
          selector:
            number:
              min: 10
              max: 50
              step: 1
              mode: box
        emhass_config_maximum_power_from_grid:
          name: maximum_power_from_grid
          description: >
            The maximum power (in W) that can be drawn from the grid at any time.
          default: 15000
          selector:
            number:
              min: 5000
              max: 100000
              step: 1000
              mode: box
        emhass_config_maximum_power_to_grid:
          name: maximum_power_to_grid
          description: >
            The maximum power (in W) that can be fed into the grid at any time.
          default: 9000
          selector:
            number:
              min: 5000
              max: 100000
              step: 1000
              mode: box
        emhass_config_inverter_is_hybrid:
          name: inverter_is_hybrid
          description: >
            Set to true if you have a hybrid inverter.
          default: true
          selector:
            boolean:
        emhass_config_inverter_ac_output_max:
          name: inverter_ac_output_max
          description: >
            Maximum AC output power (in W) of your inverter.
          default: 1000
          selector:
            number:
              min: 100
              max: 20000
              step: 100
              mode: box
        emhass_config_inverter_ac_input_max:
          name: inverter_ac_input_max
          description: >
            Maximum AC input power (in W) of your inverter.
          default: 1000
          selector:
            number:
              min: 100
              max: 20000
              step: 100
              mode: box
        emhass_config_inverter_efficiency_dc_ac:
          name: inverter_efficiency_dc_ac
          description: >
            Inverter efficiency for DC to AC conversion (e.g., 0.95).
          default: 1
          selector:
            number:
              min: 0.8
              max: 1
              step: 0.01
              mode: box
        emhass_config_inverter_efficiency_ac_dc:
          name: inverter_efficiency_ac_dc
          description: >
            Inverter efficiency for AC to DC conversion (e.g., 0.95).
          default: 1
          selector:
            number:
              min: 0.8
              max: 1
              step: 0.01
              mode: box
        emhass_config_compute_curtailment:
          name: compute_curtailment
          description: >
            Enable computation of PV curtailment.
          default: false
          selector:
            boolean:

    # --- EMHASS Tariff Configuration
    grid_emhass_tariff_config:
      name: EMHASS Tariff Configuration
      description: >
        Settings related to energy costs and feed-in tariffs.
      collapsed: true
      input:
        emhass_config_load_cost_forecast_method:
          name: load_cost_forecast_method
          description: >
            Method for retrieving load cost forecasts (e.g., 'hp_hc_periods' for peak/off-peak).
          default: hp_hc_periods
          selector:
            select:
              options:
                - hp_hc_periods
        emhass_config_load_peak_hour_periods:
          name: load_peak_hour_periods (JSON)
          description: >
            JSON definition of peak hour periods.
          default: '{"period_hp_1": [{"start": "03:00"}, {"end": "04:00"}]}'
          selector:
            text:
              type: text
              multiline: true
        emhass_config_load_peak_hours_cost:
          name: load_peak_hours_cost
          description: >
            Cost per kWh during peak hours.
          default: 0.28
          selector:
            number:
              min: 0
              max: 5
              step: 0.01
              mode: box
        emhass_config_load_offpeak_hours_cost:
          name: load_offpeak_hours_cost
          description: >
            Cost per kWh during off-peak hours.
          default: 0.28
          selector:
            number:
              min: 0
              max: 5
              step: 0.01
              mode: box
        emhass_config_production_price_forecast_method:
          name: production_price_forecast_method
          description: >
            Method for retrieving production (feed-in) price forecasts.
          default: constant
          selector:
            select:
              options:
                - constant
        emhass_config_photovoltaic_production_sell_price:
          name: photovoltaic_production_sell_price
          description: >
            The price per kWh you receive for selling PV energy to the grid.
          default: 0.1
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.1
              mode: box

    # --- EMHASS Solar System Configuration
    grid_emhass_solar_system_config:
      name: EMHASS Solar System Configuration
      description: >
        Detailed settings for PVLib-based solar forecasting.
      collapsed: true
      input:
        emhass_config_set_use_pv:
          name: set_use_pv
          description: >
            Enable or disable the use of PV forecasts in optimization.
          default: true
          selector:
            boolean:
        emhass_config_set_use_adjusted_pv:
          name: set_use_adjusted_pv
          description: >
            Enable PV forecast adjustment based on historical data.
          default: false
          selector:
            boolean:
        emhass_config_adjusted_pv_regression_model:
          name: adjusted_pv_regression_model
          description: >
            Regression model to use for PV adjustment.
          default: LassoRegression
          selector:
            select:
              options:
                - LassoRegression
        emhass_config_adjusted_pv_solar_elevation_threshold:
          name: adjusted_pv_solar_elevation_threshold
          description: >
            Solar elevation threshold for PV adjustment.
          default: 10
          selector:
            number:
              min: 0
              max: 100
              step: 1
              mode: box
        emhass_config_pv_module_model:
          name: pv_module_model (JSON List)
          description: >
            JSON list (as a string) of PV module models (from PVLib).
            Must be an array, e.g., ["My_Module_Model"] or ["Module_East", "Module_West"].
          default: '["CSUN_Eurasia_Energy_Systems_Industry_and_Trade_CSUN295_60M"]'
          selector:
            text:
              type: text
              multiline: true
        emhass_config_pv_inverter_model:
          name: pv_inverter_model (JSON List)
          description: >
            JSON list (as a string) of PV inverter models (from PVLib).
            Must be an array, e.g., ["My_Inverter_Model"] or ["Inverter_East", "Inverter_West"].
          default: '["Fronius_International_GmbH__Fronius_Primo_5_0_1_208_240__240V_"]'
          selector:
            text:
              type: text
              multiline: true
        emhass_config_surface_tilt:
          name: surface_tilt (JSON List)
          description: >
            JSON list (as a string) of panel tilt angles. Must be an array of numbers, e.g., [30] or [30, 45].
          default: "[27]"
          selector:
            text:
              type: text
              multiline: true
        emhass_config_surface_azimuth:
          name: surface_azimuth (JSON List)
          description: >
            JSON list (as a string) of panel azimuth angles (180 = South).
            Must be an array of numbers, e.g., [180] or [180, 205].
          default: "[205]"
          selector:
            text:
              type: text
              multiline: true
        emhass_config_modules_per_string:
          name: modules_per_string (JSON List)
          description: >
            JSON list (as a string) of the number of modules per string.
            Must be an array of numbers, e.g., [9] or [9, 18].
          default: "[9]"
          selector:
            text:
              type: text
              multiline: true
        emhass_config_strings_per_inverter:
          name: strings_per_inverter (JSON List)
          description: >
            JSON list (as a string) of the number of strings per inverter.
            Must be an array of numbers, e.g., [3] or [3, 6].
          default: "[3]"
          selector:
            text:
              type: text
              multiline: true

    # --- EMHASS Battery Configuration
    grid_emhass_battery_config:
      name: EMHASS Battery Configuration
      description: >
        Settings related to your battery storage system.
      collapsed: true
      input:
        emhass_config_set_use_battery:
          name: set_use_battery
          description: >
            Enable or disable the use of the battery in optimization.
          default: true
          selector:
            boolean:
        emhass_config_set_nocharge_from_grid:
          name: set_nocharge_from_grid
          description: >
            If true, battery charging from the grid is forbidden.
          default: true
          selector:
            boolean:
        emhass_config_set_nodischarge_to_grid:
          name: set_nodischarge_to_grid
          description: >
            If true, battery discharging to the grid (selling) is forbidden.
          default: true
          selector:
            boolean:
        emhass_config_set_battery_dynamic:
          name: set_battery_dynamic
          description: >
            Enable dynamic battery constraints.
          default: false
          selector:
            boolean:
        emhass_config_battery_dynamic_max:
          name: battery_dynamic_max
          description: >
            Dynamic maximum for battery (if enabled).
          default: 0.9
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.1
              mode: box
        emhass_config_battery_dynamic_min:
          name: battery_dynamic_min
          description: >
            Dynamic minimum for battery (if enabled).
          default: -0.9
          selector:
            number:
              min: -10.0
              max: 0.0
              step: 0.1
              mode: box
        emhass_config_weight_battery_discharge:
          name: weight_battery_discharge
          description: >
            Cost weight for battery discharging.
          default: 0.05
          selector:
            number:
              min: 0
              max: 10
              step: 0.01
              mode: box
        emhass_config_weight_battery_charge:
          name: weight_battery_charge
          description: >
            Cost weight for battery charging.
          default: 0
          selector:
            number:
              min: 0
              max: 10
              step: 1
              mode: box
        emhass_config_battery_discharge_power_max:
          name: battery_discharge_power_max
          description: >
            Maximum battery discharge power (in W).
          default: 6000
          selector:
            number:
              min: 0
              max: 22000
              step: 100
              mode: box
        emhass_config_battery_charge_power_max:
          name: battery_charge_power_max
          description: >
            Maximum battery charge power (in W).
          default: 6000
          selector:
            number:
              min: 0
              max: 22000
              step: 100
              mode: box
        emhass_config_battery_discharge_efficiency:
          name: battery_discharge_efficiency
          description: >
            Battery discharge efficiency (e.g., 0.95 for 95%).
          default: 0.95
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.01
              mode: box
        emhass_config_battery_charge_efficiency:
          name: battery_charge_efficiency
          description: >
            Battery charge efficiency (e.g., 0.95 for 95%).
          default: 0.95
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.01
              mode: box
        emhass_config_battery_nominal_energy_capacity:
          name: battery_nominal_energy_capacity
          description: >
            The nominal energy capacity of your battery (in Wh).
          default: 1000
          selector:
            number:
              min: 100
              max: 30000
              step: 100
              mode: box
        emhass_config_battery_minimum_state_of_charge:
          name: battery_minimum_state_of_charge
          description: >
            The minimum allowed state of charge (e.g., 0.3 for 30%).
          default: 0.3
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.05
              mode: box
        emhass_config_battery_maximum_state_of_charge:
          name: battery_maximum_state_of_charge
          description: >
            The maximum allowed state of charge (e.g., 0.9 for 90%).
          default: 0.9
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.05
              mode: box
        emhass_config_battery_target_state_of_charge:
          name: battery_target_state_of_charge
          description: >
            The target state of charge for the battery at the end of the optimization.
          default: 0.6
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.05
              mode: box
        # ignore_pv_feedback_during_curtailment

# --------------------
# --- EMHASS Variables
# --------------------

variables:
  blueprint_version: v202512
  automation_logger_name: homeassistant.components.automation.{{ this.entity_id.split('.')[1] }}
  input_automation_logger_level: !input automation_logger_level
  input_automation_trace_count: !input automation_trace_count
  input_automation_started_manually: !input automation_started_manually

  # --- EMHASS Server Variables
  emhass_rest_name: !input emhass_rest_name
  emhass_protocol: !input emhass_protocol
  emhass_host: !input emhass_host
  emhass_port: !input emhass_port
  emhass_api_publish: !input emhass_api_publish
  emhass_api_optim: !input emhass_api_optim
  emhass_api_save: !input emhass_api_save
  emhass_api_ml: !input emhass_api_ml

  # --- EMHASS Variables
  emhass_publish_minutes_timer_raw: !input publish_minutes_timer
  emhass_publish_minutes_timer_int: >
    {% set raw_value = emhass_publish_minutes_timer_raw | default("/5") %}
    {% set clean_string = raw_value | replace('/', '') %}
    {{ clean_string | int(default=5) }}
  emhass_config_soc_init_raw: !input emhass_config_soc_init
  emhass_config_soc_init_calc: >
    {% set raw_value = emhass_config_soc_init_raw | string | trim %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% else %}
      {% set single_value = raw_value | float(0) | round(2) %}
      {{ single_value }}
    {% endif %}
  emhass_config_soc_final_raw: !input emhass_config_soc_final
  emhass_config_soc_final_calc: >
    {% set raw_value = emhass_config_soc_final_raw | string | trim %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% else %}
      {% set single_value = raw_value | float(0) | round(2) %}
      {{ single_value }}
    {% endif %}
  emhass_config_battery_charge_efficiency: !input emhass_config_battery_charge_efficiency
  emhass_config_battery_charge_power_max: !input emhass_config_battery_charge_power_max
  emhass_config_battery_discharge_efficiency: !input emhass_config_battery_discharge_efficiency
  emhass_config_battery_discharge_power_max: !input emhass_config_battery_discharge_power_max
  emhass_config_battery_dynamic_max: !input emhass_config_battery_dynamic_max
  emhass_config_battery_dynamic_min: !input emhass_config_battery_dynamic_min
  emhass_config_battery_maximum_state_of_charge: !input emhass_config_battery_maximum_state_of_charge
  emhass_config_battery_minimum_state_of_charge: !input emhass_config_battery_minimum_state_of_charge
  emhass_config_battery_nominal_energy_capacity: !input emhass_config_battery_nominal_energy_capacity
  emhass_config_battery_target_state_of_charge: !input emhass_config_battery_target_state_of_charge
  emhass_config_adjusted_pv_regression_model: !input emhass_config_adjusted_pv_regression_model
  emhass_config_adjusted_pv_solar_elevation_threshold: !input emhass_config_adjusted_pv_solar_elevation_threshold
  emhass_config_compute_curtailment: !input emhass_config_compute_curtailment
  emhass_config_continual_publish: !input emhass_config_continual_publish
  emhass_config_costfun: !input emhass_config_costfun
  emhass_config_delta_forecast_daily: !input emhass_config_delta_forecast_daily
  emhass_config_historic_days_to_retrieve: !input emhass_config_historic_days_to_retrieve
  emhass_config_inverter_ac_input_max: !input emhass_config_inverter_ac_input_max
  emhass_config_inverter_ac_output_max: !input emhass_config_inverter_ac_output_max
  emhass_config_inverter_efficiency_ac_dc: !input emhass_config_inverter_efficiency_ac_dc
  emhass_config_inverter_efficiency_dc_ac: !input emhass_config_inverter_efficiency_dc_ac
  emhass_config_inverter_is_hybrid: !input emhass_config_inverter_is_hybrid
  emhass_config_logging_level: !input emhass_config_logging_level
  emhass_config_lp_solver: !input emhass_config_lp_solver
  emhass_config_lp_solver_path: !input emhass_config_lp_solver_path
  emhass_config_lp_solver_timeout: !input emhass_config_lp_solver_timeout
  emhass_config_maximum_power_from_grid: !input emhass_config_maximum_power_from_grid
  emhass_config_maximum_power_to_grid: !input emhass_config_maximum_power_to_grid
  emhass_config_method_ts_round: !input emhass_config_method_ts_round
  emhass_config_modules_per_string: !input emhass_config_modules_per_string
  emhass_config_num_threads: !input emhass_config_num_threads
  emhass_config_open_meteo_cache_max_age: !input emhass_config_open_meteo_cache_max_age
  emhass_config_optimization_time_step: !input emhass_config_optimization_time_step
  emhass_config_production_price_forecast_method: !input emhass_config_production_price_forecast_method
  emhass_config_pv_inverter_model: !input emhass_config_pv_inverter_model
  emhass_config_pv_module_model: !input emhass_config_pv_module_model
  emhass_config_set_battery_dynamic: !input emhass_config_set_battery_dynamic
  emhass_config_set_nocharge_from_grid: !input emhass_config_set_nocharge_from_grid
  emhass_config_set_nodischarge_to_grid: !input emhass_config_set_nodischarge_to_grid
  emhass_config_set_total_pv_sell: !input emhass_config_set_total_pv_sell
  emhass_config_set_use_adjusted_pv: !input emhass_config_set_use_adjusted_pv
  emhass_config_set_use_battery: !input emhass_config_set_use_battery
  emhass_config_set_use_pv: !input emhass_config_set_use_pv
  emhass_config_set_zero_min: !input emhass_config_set_zero_min
  emhass_config_solar_forecast_kwp: !input emhass_config_solar_forecast_kwp
  emhass_config_photovoltaic_production_sell_price: !input emhass_config_photovoltaic_production_sell_price
  emhass_config_sensor_power_load_no_var_loads: !input emhass_config_sensor_power_load_no_var_loads
  emhass_config_sensor_power_photovoltaics: !input emhass_config_sensor_power_photovoltaics
  emhass_config_strings_per_inverter: !input emhass_config_strings_per_inverter
  emhass_config_surface_azimuth: !input emhass_config_surface_azimuth
  emhass_config_surface_tilt: !input emhass_config_surface_tilt
  emhass_config_weather_forecast_method: !input emhass_config_weather_forecast_method
  emhass_config_weight_battery_charge: !input emhass_config_weight_battery_charge
  emhass_config_weight_battery_discharge: !input emhass_config_weight_battery_discharge
  emhass_config_get_data_from_home_assistant: !input emhass_config_get_data_from_home_assistant
  emhass_config_force_update_data: !input emhass_config_force_update_data
  emhass_config_set_forecast_to_hass: !input emhass_config_set_forecast_to_hass
  emhass_config_load_offpeak_hours_cost: !input emhass_config_load_offpeak_hours_cost
  emhass_config_load_peak_hour_periods: !input emhass_config_load_peak_hour_periods
  emhass_config_load_peak_hours_cost: !input emhass_config_load_peak_hours_cost
  emhass_config_load_cost_forecast_raw: !input emhass_config_load_cost_forecast
  emhass_config_load_cost_forecast_calc: >
    {% set raw_value = emhass_config_load_cost_forecast_raw | string | trim %}
    {% set step_minutes = emhass_config_optimization_time_step | int(30) %}
    {% set count = (1440 / step_minutes) | int(48) %}
    {% set potential_list = raw_value | from_json(default=None) %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% elif potential_list is iterable and potential_list is not string and potential_list | length == count %}
      {{ raw_value }}
    {% else %}
      {% set single_value = raw_value | float(0) | round(2) %}
      {{ [single_value] * count }}
    {% endif %}
  emhass_config_load_cost_forecast_method: !input emhass_config_load_cost_forecast_method
  emhass_config_load_forecast_method: !input emhass_config_load_forecast_method
  emhass_config_mlforecaster_payload_overwrite: !input emhass_config_mlforecaster_payload_overwrite
  emhass_config_load_negative: !input emhass_config_load_negative
  emhass_config_p_pv_forecast_raw: !input emhass_config_p_pv_forecast
  emhass_config_p_pv_forecast_calc: >
    {% set raw_value = emhass_config_p_pv_forecast_raw | string | trim %}
    {% set step_minutes = emhass_config_optimization_time_step | int(30) %}
    {% set count = (1440 / step_minutes) | int(48) %}
    {% set potential_list = raw_value | from_json(default=None) %}
    {% if '{{' in raw_value and '}}' in raw_value %}
      {{ raw_value }}
    {% elif potential_list is iterable and potential_list is not string and potential_list | length == count %}
      {{ raw_value }}
    {% else %}
      {% set single_value = raw_value | float(0) | round(1) %}
      {{ [single_value] * count }}
    {% endif %}
  list_emhass_deferrable_loads: !input list_emhass_deferrable_loads

  # Read in all currently available values and save it read-only in this variable
  snapshot: >
    {% set now_dt = now() %}
    {% set emhass_ml_forecast_json_overwrite_tmp = emhass_config_mlforecaster_payload_overwrite | default('') | string %}
    {% set step_minutes = emhass_config_optimization_time_step | default(30) | int %}
    {% set steps_per_hour = 60 / step_minutes %}
    {% set snapshot_base = {
      'current_time': now_dt | as_datetime | as_local | string,
      'automation_logger_level': input_automation_logger_level | default('info') | string | lower,
      'automation_started_manually': input_automation_started_manually | default('log') | string | lower,
      'emhass_optimization_time_step': step_minutes,
      'emhass_step_value_hour': (1 / steps_per_hour) | float,
      'emhass_steps_per_hour': (60 / step_minutes) | int,
      'emhass_current_time_delta': (now_dt - timedelta(minutes=step_minutes)) | as_datetime | as_local | string,
      'emhass_current_time_delta_publish': (now_dt - timedelta(minutes=(emhass_publish_minutes_timer_int + 1 | default(6) | int))) | as_datetime | as_local | string,
      'emhass_historic_days_to_retrieve': emhass_config_historic_days_to_retrieve | default(9) | int,
      'emhass_num_lags': (1440 / step_minutes) | int,
      'emhass_ml_forecast_json_default': {
        'historic_days_to_retrieve': emhass_config_historic_days_to_retrieve | default(9) | int,
        'var_model': emhass_config_sensor_power_load_no_var_loads | string,
        'sklearn_model': 'KNeighborsRegressor',
        'num_lags': (1440 / step_minutes) | int,
        'split_date_delta': '48h',
        'perform_backtest': ((now_dt | as_datetime | as_local).isoweekday() == 1) | bool
      },
      'emhass_ml_forecast_json_overwrite': emhass_ml_forecast_json_overwrite_tmp | from_json if emhass_ml_forecast_json_overwrite_tmp | length > 0 else {},
      'is_monday': ((now_dt | as_datetime | as_local).isoweekday() == 1) | bool
    } %}

    {# --- Namespace initialisieren --- #}
    {% set ns = namespace(
      trigger_json=[], emhass_po=[], emhass_ho=[], emhass_st=[], emhass_et=[], emhass_se=[],
      emhass_si=[], emhass_mp=[], emhass_pe=[], emhass_us=[], emhass_ss=[], emhass_changed=[],
      count=[], count_done=[], count_open=[], count_open_work=[],
      power=[], power_current=[], power_done=[], power_done_min=[],
      power_done_max=[], power_open=[], power_open_min=[], power_open_max=[]
    ) %}

    {% for item in list_emhass_deferrable_loads | default([]) %}
      {# --- Daten Laden --- #}
      {% set trigger_json_input = states(item) | from_json(default={}) %}
      {% set trigger_json_obj = states[item] %}

      {# --- Rohdaten Listen befüllen --- #}
      {% set ns.trigger_json = ns.trigger_json + [trigger_json_input | to_json] %}
      {% set ns.emhass_po = ns.emhass_po + [trigger_json_input.get('po', 0) | int] %}
      {% set ns.emhass_ho = ns.emhass_ho + [trigger_json_input.get('ho', 0) | float] %}
      {% set ns.emhass_st = ns.emhass_st + [trigger_json_input.get('st', 0) | int] %}
      {% set ns.emhass_et = ns.emhass_et + [trigger_json_input.get('et', 0) | int] %}
      {% set ns.emhass_se = ns.emhass_se + [trigger_json_input.get('se', false) | bool] %}
      {% set ns.emhass_si = ns.emhass_si + [trigger_json_input.get('si', true) | bool] %}
      {% set ns.emhass_mp = ns.emhass_mp + [trigger_json_input.get('mp', 0) | int] %}
      {% set ns.emhass_pe = ns.emhass_pe + [trigger_json_input.get('pe', 0) | int] %}
      {% set ns.emhass_us = ns.emhass_us + [trigger_json_input.get('us', 'done') | string] %}
      {% set ns.emhass_ss = ns.emhass_ss + [trigger_json_input.get('ss', 0) | int] %}

      {# --- Change Detection --- #}
      {% if trigger_json_obj is not none %}
        {% set is_changed_recently = (trigger_json_obj.last_changed > snapshot_base.emhass_current_time_delta_publish | as_datetime) | default(true) | bool %}
      {% else %}
        {% set is_changed_recently = false %}
      {% endif %}
      {% set ns.emhass_changed = ns.emhass_changed + [is_changed_recently] %}

      {# --- Power Sensor Logik --- #}
      {% set emhass_sensor = 'sensor.p_deferrable' ~ loop.index0 %}
      {% set emhass_sensor_attribute_name = (emhass_sensor | string).split('.')[-1] %}
      {% set current_power_val = states(emhass_sensor) | default(0) | int(0) %}
      {% set ns.power_current = ns.power_current + [current_power_val] %}

      {# --- Schedule Analyse --- #}
      {% set ns_deferrable = namespace(count=0, count_done=0, count_open=0, count_open_work=0,
          power=0, power_done=0, power_done_min=0, power_done_max=0, power_open=0, power_open_min=0, power_open_max=0)
      %}

      {% set emhass_sensor_deferrables_schedule_list = (state_attr(emhass_sensor, 'deferrables_schedule') | default([])) %}
      {% if emhass_sensor_deferrables_schedule_list is iterable %}
        {% for item_deferrable in emhass_sensor_deferrables_schedule_list %}
          {% set p = item_deferrable[emhass_sensor_attribute_name] | float(0) %}
          {% set d = item_deferrable.date | as_datetime %}
          {% set ns_deferrable.count = ns_deferrable.count + 1 %}
          {% set ns_deferrable.power = ns_deferrable.power + p %}

          {# Zukünftige Slots filtern #}
          {% if d >= (now_dt - timedelta(minutes=step_minutes)) %}
            {% set ns_deferrable.count_open = ns_deferrable.count_open + 1 %}
            {% set ns_deferrable.power_open = ns_deferrable.power_open + p %}

            {# NEU: Zähle nur Slots mit echter Arbeit (> 0 Watt) #}
            {% if p > 0 %}
              {% set ns_deferrable.count_open_work = ns_deferrable.count_open_work + 1 %}

              {% if ns_deferrable.power_open_min <= 0 %}
                {% set ns_deferrable.power_open_min = p %}
              {% else %}
                {% set ns_deferrable.power_open_min = [ns_deferrable.power_open_min, p] | min %}
              {% endif %}
              {% set ns_deferrable.power_open_max = [ns_deferrable.power_open_max, p] | max %}
            {% endif %}
          {% else %}
            {# Vergangene Slots #}
            {% if ns_deferrable.power_done_min <= 0 %}
              {% set ns_deferrable.power_done_min = p %}
            {% else %}
              {% set ns_deferrable.power_done_min = [ns_deferrable.power_done_min, p] | min %}
            {% endif %}
            {% set ns_deferrable.power_done_max = [ns_deferrable.power_done_max, p] | max %}
            {% set ns_deferrable.count_done = ns_deferrable.count_done + 1 %}
            {% set ns_deferrable.power_done = ns_deferrable.power_done + p %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {# --- Stats in Hauptlisten schieben --- #}
      {% set ns.count = ns.count + [ns_deferrable.count] %}
      {% set ns.count_done = ns.count_done + [ns_deferrable.count_done] %}
      {% set ns.count_open = ns.count_open + [ns_deferrable.count_open] %}
      {% set ns.count_open_work = ns.count_open_work + [ns_deferrable.count_open_work] %}
      {% set ns.power = ns.power + [ns_deferrable.power] %}
      {% set ns.power_done = ns.power_done + [ns_deferrable.power_done] %}
      {% set ns.power_done_min = ns.power_done_min + [ns_deferrable.power_done_min] %}
      {% set ns.power_done_max = ns.power_done_max + [ns_deferrable.power_done_max] %}
      {% set ns.power_open = ns.power_open + [ns_deferrable.power_open] %}
      {% set ns.power_open_min = ns.power_open_min + [ns_deferrable.power_open_min] %}
      {% set ns.power_open_max = ns.power_open_max + [ns_deferrable.power_open_max] %}
    {% endfor %}

    {# --- Output zusammenbauen --- #}
    {% set def = {
      'trigger_json': ns.trigger_json,
      'emhass_trigger_po': ns.emhass_po,
      'emhass_trigger_ho': ns.emhass_ho,
      'emhass_trigger_st': ns.emhass_st,
      'emhass_trigger_et': ns.emhass_et,
      'emhass_trigger_se': ns.emhass_se,
      'emhass_trigger_si': ns.emhass_si,
      'emhass_trigger_mp': ns.emhass_mp,
      'emhass_trigger_pe': ns.emhass_pe,
      'emhass_trigger_us': ns.emhass_us,
      'emhass_trigger_ss': ns.emhass_ss,
      'emhass_trigger_changed': ns.emhass_changed,
      'emhass_deferrable_count': ns.count,
      'emhass_deferrable_count_done': ns.count_done,
      'emhass_deferrable_count_open': ns.count_open,
      'emhass_deferrable_count_open_work': ns.count_open_work,
      'emhass_deferrable_power': ns.power,
      'emhass_deferrable_power_current': ns.power_current,
      'emhass_deferrable_power_done': ns.power_done,
      'emhass_deferrable_power_done_min': ns.power_done_min,
      'emhass_deferrable_power_done_max': ns.power_done_max,
      'emhass_deferrable_power_open': ns.power_open,
      'emhass_deferrable_power_open_min': ns.power_open_min,
      'emhass_deferrable_power_open_max': ns.power_open_max
    } %}
    {{ (snapshot_base | combine(def)) | to_json }}

# -------------------
# --- EMHASS Triggers
# -------------------

triggers:

  # --- Run by HA Start
  - trigger: homeassistant
    event: start
    id: ha_start

  # --- Publish and Optim Data
  - trigger: time_pattern
    minutes: !input publish_minutes_timer
    seconds: 18
    id: publish
    enabled: !input enable_publish_timer

  # --- Save Config
  - trigger: time_pattern
    hours: !input save_timer_hours
    minutes: !input save_timer_minutes
    seconds: 18
    id: save
    enabled: !input enable_save_timer

  # --- Run Forecast
  - trigger: time_pattern
    hours: !input forecast_timer_hours
    minutes: !input forecast_timer_minutes
    seconds: 18
    id: forecast
    enabled: !input enable_forecast_timer

# ---------------------
# --- EMHASS Conditions
# ---------------------

conditions: []

# ------------------
# --- EMHASS Actions
# ------------------

actions:

  - variables:
      context: >
        {% set config = snapshot | from_json %}
        {% set automation_trigger_id = trigger.id | default('none') | string | lower %}
        {% set current_time = (config.current_time | as_datetime) %}
        {% set res = namespace(
          publish_enabled = false, optim_enabled = false, save_enabled = false, forecast_enabled = false,
          new_ho = [], new_st = [], new_et = [], log_msg = [])
        %}

        {% set res.log_msg = res.log_msg + ['Automation started by trigger id ' ~ automation_trigger_id] %}

        {# --- Action save enabled --- #}
        {% if
            (
              automation_trigger_id == 'save'
            ) or (
              automation_trigger_id == 'none' and
              config.automation_started_manually in ['all', 'save']
            )
        %}
          {% set res.log_msg = res.log_msg + ['Action save enabled'] %}
          {% set res.save_enabled = true %}
        {% endif %}

        {# --- Action forecast enabled --- #}
        {% if
            (
              automation_trigger_id == 'forecast'
            ) or (
              automation_trigger_id == 'none' and
              config.automation_started_manually in ['all', 'forecast']
            )
        %}
          {% set res.log_msg = res.log_msg + ['Action forecast enabled'] %}
          {% set res.forecast_enabled = true %}
        {% endif %}

        {# --- Action optim enabled --- #}
        {% for i in range(config.trigger_json | length) %}
          {% if
              (
                config.emhass_trigger_changed[i] and
                automation_trigger_id == 'publish' and
                (
                  (
                    config.emhass_trigger_us[i] == 'wait' and
                    config.emhass_deferrable_power_open[i] == 0
                  ) or (
                    (config.emhass_trigger_us[i] in ['running', 'force'] or (config.emhass_trigger_us[i]).startswith('force-')) and
                    config.emhass_deferrable_power_current[i] == 0
                  ) or (
                    config.emhass_trigger_us[i] == 'done' and
                    config.emhass_deferrable_power_open[i] > 0
                  )
                )
              ) or (
                automation_trigger_id == 'none' and
                config.automation_started_manually in ['all', 'optim']
              ) or (
                (current_time).hour % 4 == 0 and
                (current_time).minute == 0
              )
          %}
            {% set res.log_msg = res.log_msg + ['Action optim enabled by sensor.p_deferrable' ~ i] %}
            {% set res.optim_enabled = true %}
            {% break %}
          {% endif %}
        {% endfor %}

        {# --- Action publish enabled --- #}
        {% if
            (
              automation_trigger_id in ['publish', 'ha_start']
            ) or (
              automation_trigger_id == 'none' and
              config.automation_started_manually in ['all', 'publish']
            )
        %}
          {% set res.log_msg = res.log_msg + ['Action publish enabled'] %}
          {% set res.publish_enabled = true %}
        {% endif %}

        {# --- Action recalculate running triggers for new optim --- #}
        {% for i in range(config.trigger_json | length) %}
          {% set calc_trigger = namespace(
            ho = config.emhass_trigger_ho[i], st = config.emhass_trigger_st[i], et = config.emhass_trigger_et[i],
            sensor_ho = 0)
          %}

          {% if config.emhass_trigger_si[i] == true %}
            {% set calc_trigger.sensor_ho = config.emhass_deferrable_count_open_work[i] * config.emhass_step_value_hour %}
          {% else %}
            {% set calc_trigger.sensor_ho = (config.emhass_deferrable_power_open[i] * config.emhass_step_value_hour) / config.emhass_trigger_po[i] %}
          {% endif %}

          {% if config.emhass_trigger_ss[i] > 0 and calc_trigger.sensor_ho > 0.01 %}
            {% set res.log_msg = res.log_msg + ['Recalculate trigger data (ho/st/et) for sensor.p_deferrable' ~ i] %}
            {% set calc_trigger.ho = ((calc_trigger.sensor_ho * config.emhass_steps_per_hour) | round(0)) / config.emhass_steps_per_hour %}
            {% set calc_trigger.st = 0 %}
            {% set elapsed_seconds = as_timestamp((config.emhass_current_time_delta | as_datetime)) - config.emhass_trigger_ss[i] %}
            {% set elapsed_steps = (elapsed_seconds / 60) / config.emhass_optimization_time_step %}
            {% if
              config.emhass_trigger_si[i] == true and
              (
                config.emhass_deferrable_power_current[i] > 0 or
                config.emhass_trigger_us[i] == 'force' or
                (config.emhass_trigger_us[i]).startswith('force-')
              )
            %}
              {% set calc_trigger.et = config.emhass_deferrable_count_open_work[i] %}
            {% else %}
              {% set calc_trigger.et = (config.emhass_trigger_et[i] - elapsed_steps) | int %}
            {% endif %}
            {% if calc_trigger.et < 0 %}
              {% set calc_trigger.et = 0 %}
            {% endif %}
          {% else %}
            {% if config.emhass_trigger_us[i] in ['running', 'force'] or (config.emhass_trigger_us[i]).startswith('force-') %}
              {% set res.log_msg = res.log_msg + ['WARNING: It appears that more energy is being used than planned. Check that ho, st, and et are still correct.'] %}
              {% set res.log_msg = res.log_msg + ['WARNING: The emhass plan does not include additional energy, even though it is in an active state.'] %}
            {% endif %}
            {% set res.log_msg = res.log_msg + ['Input (Fallback/Start) for sensor.p_deferrable' ~ i] %}
          {% endif %}

          {% set res.new_ho = res.new_ho + [calc_trigger.ho] %}
          {% set res.new_st = res.new_st + [calc_trigger.st] %}
          {% set res.new_et = res.new_et + [calc_trigger.et] %}
        {% endfor %}
        {% set res.log_msg = res.log_msg + ['New ho / st / et: ' ~ (res.new_ho | join('; ')) ~ ' / ' ~ (res.new_st | join('; ')) ~ ' / ' ~ (res.new_et | join('; '))] %}

        {{ {
          'automation': {
            'trigger_id': automation_trigger_id,
            'logger_level': config.automation_logger_level,
            'started_manually': config.automation_started_manually,
            'publish_enabled': res.publish_enabled,
            'optim_enabled': res.optim_enabled,
            'save_enabled': res.save_enabled,
            'forecast_enabled': res.forecast_enabled
          },
          'result': {
            'optim': {
              'soc_init': emhass_config_soc_init_calc,
              'soc_final': emhass_config_soc_final_calc,
              'load_cost_forecast': emhass_config_load_cost_forecast_calc,
              'p_pv_forecast': emhass_config_p_pv_forecast_calc,
              'pv_power_forecast': emhass_config_p_pv_forecast_calc,
              'end_timesteps_of_each_deferrable_load': res.new_et,
              'minimum_power_of_deferrable_loads': config.emhass_trigger_mp,
              'nominal_power_of_deferrable_loads': config.emhass_trigger_po,
              'operating_hours_of_each_deferrable_load': res.new_ho,
              'set_deferrable_load_single_constant': config.emhass_trigger_si,
              'set_deferrable_startup_penalty': config.emhass_trigger_pe,
              'start_timesteps_of_each_deferrable_load': res.new_st,
              'treat_deferrable_load_as_semi_cont': config.emhass_trigger_se
            },
            'publish': {},
            'save': {
              'soc_init': emhass_config_soc_init_calc,
              'soc_final': emhass_config_soc_final_calc,
              'battery_charge_efficiency': emhass_config_battery_charge_efficiency,
              'battery_charge_power_max': emhass_config_battery_charge_power_max,
              'battery_discharge_efficiency': emhass_config_battery_discharge_efficiency,
              'battery_discharge_power_max': emhass_config_battery_discharge_power_max,
              'battery_dynamic_max': emhass_config_battery_dynamic_max,
              'battery_dynamic_min': emhass_config_battery_dynamic_min,
              'battery_maximum_state_of_charge': emhass_config_battery_maximum_state_of_charge,
              'battery_minimum_state_of_charge': emhass_config_battery_minimum_state_of_charge,
              'battery_nominal_energy_capacity': emhass_config_battery_nominal_energy_capacity,
              'battery_target_state_of_charge': emhass_config_battery_target_state_of_charge,
              'adjusted_pv_regression_model': emhass_config_adjusted_pv_regression_model,
              'adjusted_pv_solar_elevation_threshold': emhass_config_adjusted_pv_solar_elevation_threshold,
              'compute_curtailment': emhass_config_compute_curtailment,
              'continual_publish': emhass_config_continual_publish,
              'costfun': emhass_config_costfun,
              'delta_forecast_daily': emhass_config_delta_forecast_daily,
              'historic_days_to_retrieve': emhass_config_historic_days_to_retrieve,
              'inverter_ac_input_max': emhass_config_inverter_ac_input_max,
              'inverter_ac_output_max': emhass_config_inverter_ac_output_max,
              'inverter_efficiency_ac_dc': emhass_config_inverter_efficiency_ac_dc,
              'inverter_efficiency_dc_ac': emhass_config_inverter_efficiency_dc_ac,
              'inverter_is_hybrid': emhass_config_inverter_is_hybrid,
              'logging_level': emhass_config_logging_level,
              'lp_solver': emhass_config_lp_solver,
              'lp_solver_path': emhass_config_lp_solver_path,
              'lp_solver_timeout': emhass_config_lp_solver_timeout,
              'maximum_power_from_grid': emhass_config_maximum_power_from_grid,
              'maximum_power_to_grid': emhass_config_maximum_power_to_grid,
              'method_ts_round': emhass_config_method_ts_round,
              'modules_per_string': emhass_config_modules_per_string | from_json,
              'num_threads': emhass_config_num_threads,
              'open_meteo_cache_max_age': emhass_config_open_meteo_cache_max_age,
              'optimization_time_step': emhass_config_optimization_time_step | int(30),
              'production_price_forecast_method': emhass_config_production_price_forecast_method,
              'pv_inverter_model': emhass_config_pv_inverter_model | from_json,
              'pv_module_model': emhass_config_pv_module_model | from_json,
              'set_battery_dynamic': emhass_config_set_battery_dynamic,
              'set_nocharge_from_grid': emhass_config_set_nocharge_from_grid,
              'set_nodischarge_to_grid': emhass_config_set_nodischarge_to_grid,
              'set_total_pv_sell': emhass_config_set_total_pv_sell,
              'set_use_adjusted_pv': emhass_config_set_use_adjusted_pv,
              'set_use_battery': emhass_config_set_use_battery,
              'set_use_pv': emhass_config_set_use_pv,
              'set_zero_min': emhass_config_set_zero_min,
              'solar_forecast_kwp': emhass_config_solar_forecast_kwp,
              'photovoltaic_production_sell_price': emhass_config_photovoltaic_production_sell_price,
              'sensor_power_load_no_var_loads': emhass_config_sensor_power_load_no_var_loads,
              'sensor_power_photovoltaics': emhass_config_sensor_power_photovoltaics,
              'sensor_replace_zero': [ emhass_config_sensor_power_photovoltaics | string ],
              'strings_per_inverter': emhass_config_strings_per_inverter | from_json,
              'surface_azimuth': emhass_config_surface_azimuth | from_json,
              'surface_tilt': emhass_config_surface_tilt | from_json,
              'weather_forecast_method': emhass_config_weather_forecast_method,
              'weight_battery_charge': emhass_config_weight_battery_charge,
              'weight_battery_discharge': emhass_config_weight_battery_discharge,
              'get_data_from_home_assistant': emhass_config_get_data_from_home_assistant,
              'force_update_data': emhass_config_force_update_data,
              'set_forecast_to_hass': emhass_config_set_forecast_to_hass,
              'load_offpeak_hours_cost': emhass_config_load_offpeak_hours_cost,
              'load_peak_hour_periods': emhass_config_load_peak_hour_periods | from_json,
              'load_peak_hours_cost': emhass_config_load_peak_hours_cost,
              'load_cost_forecast': emhass_config_load_cost_forecast_calc,
              'load_cost_forecast_method': emhass_config_load_cost_forecast_method,
              'load_forecast_method': emhass_config_load_forecast_method,
              'load_negative': emhass_config_load_negative,
              'p_pv_forecast': emhass_config_p_pv_forecast_calc,
              'pv_power_forecast': emhass_config_p_pv_forecast_calc,
              'sensor_linear_interp': [
                emhass_config_sensor_power_photovoltaics | string,
                emhass_config_sensor_power_load_no_var_loads | string
              ],
              'end_timesteps_of_each_deferrable_load': res.new_et,
              'minimum_power_of_deferrable_loads': config.emhass_trigger_mp,
              'nominal_power_of_deferrable_loads': config.emhass_trigger_po,
              'number_of_deferrable_loads': config.trigger_json | length,
              'operating_hours_of_each_deferrable_load': ([0] * (config.trigger_json | length)),
              'set_deferrable_load_single_constant': config.emhass_trigger_si,
              'set_deferrable_startup_penalty': config.emhass_trigger_pe,
              'start_timesteps_of_each_deferrable_load': res.new_st,
              'treat_deferrable_load_as_semi_cont': config.emhass_trigger_se
            },
            'forecast': config.emhass_ml_forecast_json_default | combine(config.emhass_ml_forecast_json_overwrite)
          },
          'logs': res.log_msg
        } | to_json }}

  # --- Run EMHASS Actions
  - alias: Logging
    parallel:
    - alias: Info logging
      if:
        - condition: template
          value_template: >
            {% set config = context | from_json %}
            {{ config.automation.logger_level == 'info' }}
      then:
        - service: system_log.write
          data:
            level: info
            logger: "{{ automation_logger_name }}"
            message: >
              [INFO]:
              result data: {{ (context | from_json).result }}
              logs: {{ (context | from_json).logs }}
    - alias: Warning logging
      if:
        - condition: template
          value_template: >
            {% set config = context | from_json %}
            {{ config.automation.logger_level in ['debug', 'warning'] }}
      then:
        - service: system_log.write
          data:
            level: warning
            logger: "{{ automation_logger_name }}"
            message: >
              [WARNING]:
              result data: {{ (context | from_json).result }}
              logs: {{ (context | from_json).logs }}
    - alias: Debug logging
      if:
        - condition: template
          value_template: >
            {% set config = context | from_json %}
            {{ config.automation.logger_level == 'debug' }}
      then:
        - service: system_log.write
          data:
            level: warning
            logger: "{{ automation_logger_name }}"
            message: >
              [DEBUG]:
              snapshot: {{ snapshot }}
              context: {{ context | from_json }}

  - alias: EMHASS Basic Automation run save
    if:
      - condition: template
        value_template: >
          {% set config = context | from_json %}
          {{ config.automation.save_enabled | default(true) | bool }}
    then:
      - action: !input emhass_rest_name
        data:
          protocol: !input emhass_protocol
          host: !input emhass_host
          port: !input emhass_port
          api: !input emhass_api_save
          payload: >
            {% set config = context | from_json %}
            {{ config.result.save | to_json }}
        response_variable: response_publish_save

  - alias: EMHASS Basic Automation run forecast
    if:
      - condition: template
        value_template: >
          {% set config = context | from_json %}
          {{ config.automation.forecast_enabled | default(true) | bool }}
    then:
      - action: !input emhass_rest_name
        data:
          protocol: !input emhass_protocol
          host: !input emhass_host
          port: !input emhass_port
          api: !input emhass_api_ml
          payload: >
            {% set config = context | from_json %}
            {{ config.result.forecast | to_json }}
        response_variable: response_publish_forecast

  - alias: EMHASS Basic Automation run optim
    if:
      - condition: template
        value_template: >
          {% set config = context | from_json %}
          {{ config.automation.optim_enabled | default(true) | bool }}
    then:
      - action: !input emhass_rest_name
        data:
          protocol: !input emhass_protocol
          host: !input emhass_host
          port: !input emhass_port
          api: !input emhass_api_optim
          payload: >
            {% set config = context | from_json %}
            {{ config.result.optim | to_json }}
        response_variable: response_payload_optim
      - delay:
          hours: 0
          minutes: 0
          seconds: 5
          milliseconds: 0

  - alias: EMHASS Basic Automation run publish
    if:
      - condition: template
        value_template: >
          {% set config = context | from_json %}
          {{ config.automation.publish_enabled | default(true) | bool }}
    then:
      - action: !input emhass_rest_name
        data:
          protocol: !input emhass_protocol
          host: !input emhass_host
          port: !input emhass_port
          api: !input emhass_api_publish
          payload: >
            {% set config = context | from_json %}
            {{ config.result.publish | to_json }}
        response_variable: response_payload_publish

# -------------------
# --- Automation Mode
# -------------------

mode: single
max_exceeded: silent
trace:
  stored_traces: !input automation_trace_count
